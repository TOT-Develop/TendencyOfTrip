<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="totreviews.mapper.TReviewMapper">

  	<insert id="insertTReview" parameterType="TReviewVO" useGeneratedKeys="true" keyProperty="trevid">
        <selectKey keyProperty="trevid" resultType="int" order="BEFORE">
            SELECT seq_trevid.nextval FROM dual
        </selectKey>
        INSERT INTO TREVIEW (TREVID, TRIPID, MEMID, TREVSTATUS, TREVTITLE, TREVCOURSE, TREVCONTENT, TREVRATING, TREVREGDATE, TREVUPDATE, TREVCOUNT)
        VALUES (#{trevid}, #{tripid}, #{memid}, #{trevstatus}, #{trevtitle}, #{trevcourse}, #{trevcontent}, 
        #{trevrating}, #{trevregdate}, #{trevupdate}, #{trevcount})
    </insert>
    
    <insert id="insertTReviewImage" parameterType="TReviewImageVO">
        INSERT INTO TREVIEWIMAGE (TREVIMGID, TREVID, MEMID, TREVIMGPATH, TREVIMGREGDATE, TREVIMGUPDATE)
        VALUES (seq_trevimgid.nextval, #{trevid}, #{memid}, #{trevimgpath}, #{trevimgregdate}, #{trevimgupdate})
    </insert>
    
    <select id="getAllTReviews" resultMap="TReviewResDTOResultMap">
    	SELECT r.TREVID, r.TRIPID, r.MEMID, r.TREVSTATUS, r.TREVTITLE, r.TREVCOURSE, r.TREVCONTENT, LISTAGG(i.TREVIMGPATH, ',') WITHIN GROUP (ORDER BY i.TREVIMGID) AS TREVIMGPATH, r.TREVRATING, r.TREVREGDATE, r.TREVUPDATE, r.TREVCOUNT 
		FROM TREVIEW r 
		LEFT JOIN TReviewImage i 
		ON r.TREVID = i.TREVID 
		GROUP BY r.TREVID, r.TRIPID, r.MEMID, r.TREVSTATUS, r.TREVTITLE, r.TREVCOURSE, r.TREVCONTENT, r.TREVRATING, r.TREVREGDATE, r.TREVUPDATE, r.TREVCOUNT
    </select>

	<resultMap id="TReviewResDTOResultMap" type="TReviewResDTO">
        <id property="trevid" column="TREVID" />
        <result property="tripid" column="TRIPID" />
        <result property="memid" column="MEMID" />
        <result property="trevstatus" column="TREVSTATUS" />
        <result property="trevtitle" column="TREVTITLE" />
        <result property="trevcourse" column="TREVCOURSE" />
        <result property="trevcontent" column="TREVCONTENT" />
        <result property="trevimgpath" column="TREVIMGPATH" />
        <result property="trevrating" column="TREVRATING" />
        <result property="trevregdate" column="TREVREGDATE" />
        <result property="trevupdate" column="TREVUPDATE" />
        <result property="trevcount" column="TREVCOUNT" />
    </resultMap>
	
</mapper>
