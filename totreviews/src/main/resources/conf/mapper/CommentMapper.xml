<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="totreviews.mapper.CommentMapper">

    <select id="getCommentsByReviewId" parameterType="int" resultMap="CommentVOMap">
    	SELECT
            TREVCID AS commentId,
            TREVID AS postId,
            TOPPARENTID AS topParentId,
            PARENTID AS parentId,
            MEMNICK AS memnick,
            COMMENTSTATUS AS status,
            TREVCTEXT AS content,
            TREVDEPTH AS depth,
            TREVCREGDATE AS regdate,
            TREVDUPDATE AS updates
        FROM 
            TREVIEWCOMMENT
        WHERE 
            TREVID = #{trevid}
        ORDER BY TOPPARENTID ASC, PARENTID ASC, TREVDEPTH ASC, TREVCREGDATE ASC
    </select>
    
    <select id="getCommentById" parameterType="int" resultType="CommentVO">
	    SELECT
	        TREVCID AS commentId,
	        TREVID AS postId,
	        TOPPARENTID AS topParentId,
	        PARENTID AS parentId,
	        MEMID AS memId,
	        MEMNICK AS memnick,
	        COMMENTSTATUS AS status,
	        TREVCTEXT AS content,
	        TREVDEPTH AS depth,
	        TREVCREGDATE AS regdate,
	        TREVDUPDATE AS updates
	    FROM 
	        TREVIEWCOMMENT
	    WHERE 
	        TREVCID = #{commentId}
	</select>  
    
    <insert id="insertComment" parameterType="CommentVO" useGeneratedKeys="true" keyProperty="commentId">
    <selectKey keyProperty="commentId" resultType="int" order="BEFORE">
		SELECT SEQ_TREVCID.NEXTVAL FROM dual
	</selectKey>
	    INSERT INTO TREVIEWCOMMENT (
            TREVCID,
            TREVID,
            TOPPARENTID,
            PARENTID,
            MEMID,
            MEMNICK,
            TREVCTEXT,
            TREVDEPTH,
            TREVCREGDATE
        )
        VALUES (
            #{commentId},
            #{postId},
            #{topParentId},
            #{parentId},
            #{memId},
            #{memnick},
            #{content},
            #{depth},
            CURRENT_TIMESTAMP
        )
    </insert>
    
    <update id="updateTopParentId" parameterType="int">
	    UPDATE TREVIEWCOMMENT
	    SET TOPPARENTID = #{commentId}
	    WHERE TREVCID = #{commentId}
	</update>
	
	<resultMap id="CommentVOMap" type="CommentVO">
        <id property="commentId" column="commentId"/>
        <result property="postId" column="postId"/>
        <result property="topParentId" column="topParentId"/>
        <result property="parentId" column="parentId"/>
        <result property="memId" column="memId"/> 
        <result property="memnick" column="memnick"/>   
        <result property="status" column="status"/>          
        <result property="content" column="content"/> 
        <result property="depth" column="depth"/>
        <result property="regdate" column="regdate"/>    
        <result property="update" column="update"/>      
    </resultMap>

</mapper>
