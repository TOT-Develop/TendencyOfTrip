<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="totreviews.mapper.AdminCommentMapper">

	<select id="getCommentsByReviewId" parameterType="int" resultMap="CommentVOMap">
		SELECT
            TREVCID AS commentId,
            TREVID AS postId,
            TOPPARENTID AS topParentId,
            PARENTID AS parentId,
            PARENTNICKNAME AS parentNickname,
            MEMID AS memId,
            MEMNICK AS memNick,
            COMMENTSTATUS AS status,
            TREVCTEXT AS content,
            TREVDEPTH AS depth,
            TREVCREGDATE AS regDate,
            TREVDUPDATE AS updates
		FROM
		    TREVIEWCOMMENT
		WHERE
		    TREVID = #{trevId}
		START WITH
		    TREVCID = TOPPARENTID      
		CONNECT BY
		    PRIOR TREVCID = PARENTID    
		ORDER SIBLINGS BY
		    TREVCREGDATE ASC     
    </select>
    
    <select id="findInactiveParentComments" resultType="string">
	    SELECT COMMENTSTATUS
	    FROM TREVIEWCOMMENT
	    WHERE TREVCID IN (
	        SELECT PARENTID
	        FROM TREVIEWCOMMENT
	        START WITH TREVCID IN
	        <foreach item="trevcId" collection="list" open="(" separator="," close=")">
	            #{trevcId}
	        </foreach>
	        CONNECT BY PRIOR PARENTID = TREVCID
	    )
	    AND COMMENTSTATUS IN('CMT002', 'CMT004')
	</select>

	<update id="updateCommentStatus">
		UPDATE TREVIEWCOMMENT
    	<set> 
    		<if test="status == 'active'">
	            COMMENTSTATUS = 'CMT001',
	        </if>
	        <if test="status == 'deactive'">
	            COMMENTSTATUS = 'CMT004',
	        </if>
        </set>
		WHERE TREVCID IN (
	        SELECT TREVCID
	        FROM (
	            SELECT TREVCID
	            FROM TREVIEWCOMMENT
	            START WITH TREVCID IN
	            <foreach item="trevcId" collection="trevcIds" open="(" separator="," close=")">
	                #{trevcId}
	            </foreach>
	            CONNECT BY PRIOR TREVCID = PARENTID
	        )
	    )
	</update>
	
	<resultMap id="CommentVOMap" type="CommentVO">
        <id property="commentId" column="commentId"/>
        <result property="postId" column="postId"/>
        <result property="topParentId" column="topParentId"/>
        <result property="parentId" column="parentId"/>
        <result property="parentNickname" column="parentNickname"/>
        <result property="memId" column="memId"/> 
        <result property="memNick" column="memNick"/>   
        <result property="status" column="status"/>          
        <result property="content" column="content"/> 
        <result property="depth" column="depth"/>
        <result property="regDate" column="regDate"/>    
        <result property="update" column="updates"/>      
    </resultMap>

</mapper>
